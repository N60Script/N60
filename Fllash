-- Services
local Players = game:GetService("Players")
local ProximityPromptService = game:GetService("ProximityPromptService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local enabled = false
local currentPrompt = nil

-- =========================
-- Flash Equip Function
-- =========================
local function equipFlash()
    local char = player.Character
    local backpack = player:FindFirstChild("Backpack")
    if not char or not backpack then return end

    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end

    local names = {
        "FlashTeleport",
        "Flash Teleport",
        "FlashTP",
        "Flash TP"
    }

    -- Backpack
    for _,name in ipairs(names) do
        local tool = backpack:FindFirstChild(name)
        if tool then
            humanoid:EquipTool(tool)
            return tool
        end
    end

    -- Already equipped
    for _,name in ipairs(names) do
        local tool = char:FindFirstChild(name)
        if tool then
            return tool
        end
    end
end

-- =========================
-- Proximity Tracking
-- =========================
ProximityPromptService.PromptShown:Connect(function(prompt)
    currentPrompt = prompt
end)

ProximityPromptService.PromptHidden:Connect(function(prompt)
    if currentPrompt == prompt then
        currentPrompt = nil
    end
end)

-- =========================
-- Input Detect (E)
-- =========================
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.E
    and enabled
    and currentPrompt then

        task.spawn(function()
            task.wait(0.05) -- قبل التفعيل
            equipFlash()
            task.wait()
            pcall(function()
                fireproximityprompt(currentPrompt)
            end)
        end)
    end
end)

-- =========================
-- GUI Button (Right Middle)
-- =========================
local gui = Instance.new("ScreenGui", player.PlayerGui)
gui.ResetOnSpawn = false
gui.Name = "FlashQuickButton"

local btn = Instance.new("TextButton")
btn.Size = UDim2.new(0,120,0,40)
btn.Position = UDim2.new(1,-130,0.5,-20)
btn.BackgroundColor3 = Color3.fromRGB(0,0,0)
btn.TextColor3 = Color3.fromRGB(255,255,255)
btn.Text = "FLASH: OFF"
btn.Font = Enum.Font.GothamBold
btn.TextSize = 14
btn.Parent = gui
Instance.new("UICorner", btn).CornerRadius = UDim.new(0,8)

btn.MouseButton1Click:Connect(function()
    enabled = not enabled
    btn.Text = enabled and "FLASH: ON" or "FLASH: OFF"
    btn.BackgroundColor3 = enabled
        and Color3.fromRGB(0,170,255)
        or Color3.fromRGB(0,0,0)
end)

print("⚡ Flash Proximity Helper Loaded")
