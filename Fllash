local Players = game:GetService("Players")
local ProximityPromptService = game:GetService("ProximityPromptService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local StarterGui = game:GetService("StarterGui")

local player = Players.LocalPlayer
local tpOnStealEnabled = false

--======================== ANTI-KICK =========================--

local function antiKick()
    pcall(function()
        for _,v in pairs(getconnections(player.Idled)) do
            v:Disable()
        end
    end)
    
    pcall(function()
        local mt = getrawmetatable(game)
        setreadonly(mt, false)
        local old = mt.__namecall
        mt.__namecall = newcclosure(function(self, ...)
            local method = getnamecallmethod()
            if method == "Kick" or method == "kick" then
                return nil
            end
            return old(self, ...)
        end)
    end)
end

pcall(antiKick)

if player.PlayerGui:FindFirstChild("CloudHubFlashTP") then
	player.PlayerGui.CloudHubFlashTP:Destroy()
end

--======================== NOTIFICATION SYSTEM =========================--

local function sendNotification(title, text, duration)
    pcall(function()
        StarterGui:SetCore("SendNotification", {
            Title = title,
            Text = text,
            Duration = duration or 5,
            Icon = "rbxassetid://7733955740"
        })
    end)
end

--======================== FLASH TELEPORT EQUIP FUNCTION =========================--

local function equipFlashTeleport()
    local backpack = player:FindFirstChild("Backpack")
    local character = player.Character
    
    if not backpack or not character then 
        sendNotification("❌ Cloud Hub", "Character not found!", 3)
        return false 
    end
    
    local itemsToFind = {
        "FlashTeleport",
        "Flash Teleport",
        "FlashTP",
        "Flash TP"
    }
    
    -- Check in backpack
    for _, itemName in ipairs(itemsToFind) do
        local item = backpack:FindFirstChild(itemName)
        if item and item:IsA("Tool") then
            character:FindFirstChildOfClass("Humanoid"):EquipTool(item)
            return true
        end
    end
    
    -- Check if already equipped
    for _, itemName in ipairs(itemsToFind) do
        if character:FindFirstChild(itemName) then
            return true
        end
    end
    
    -- Not found - send notification
    sendNotification("❌ Flash Teleport", "Flash Teleport tool not found in inventory!", 5)
    return false
end

--======================== GUI PRINCIPAL =========================--

local screenGui = Instance.new("ScreenGui", player.PlayerGui)
screenGui.Name = "CloudHubFlashTP"
screenGui.ResetOnSpawn = false

local GUI_WIDTH = 300
local TITLE_HEIGHT = 35
local PADDING = 15
local BUTTON_HEIGHT = 45
local FOOTER_HEIGHT = 25

local totalHeight = TITLE_HEIGHT + PADDING*3 + BUTTON_HEIGHT + FOOTER_HEIGHT

local mainGuiFrame = Instance.new("Frame")
mainGuiFrame.Name = "MainFrame"
mainGuiFrame.Size = UDim2.new(0, GUI_WIDTH, 0, totalHeight)
mainGuiFrame.AnchorPoint = Vector2.new(0.5, 0.5)
mainGuiFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
mainGuiFrame.BackgroundColor3 = Color3.fromRGB(255,255,255)
mainGuiFrame.BorderSizePixel = 0
mainGuiFrame.Parent = screenGui
Instance.new("UICorner", mainGuiFrame).CornerRadius = UDim.new(0,12)

-- Rainbow border
local borderFrame = Instance.new("Frame")
borderFrame.Size = UDim2.new(1,0,1,0)
borderFrame.Position = UDim2.new(0,0,0,0)
borderFrame.BackgroundColor3 = Color3.fromRGB(255,255,255)
borderFrame.Parent = mainGuiFrame
Instance.new("UICorner", borderFrame).CornerRadius = UDim.new(0,12)

local rainbowGradient = Instance.new("UIGradient")
rainbowGradient.Color = ColorSequence.new({
	ColorSequenceKeypoint.new(0, Color3.fromRGB(255,0,0)),
	ColorSequenceKeypoint.new(0.15, Color3.fromRGB(255,128,0)),
	ColorSequenceKeypoint.new(0.33, Color3.fromRGB(255,255,0)),
	ColorSequenceKeypoint.new(0.5, Color3.fromRGB(0,255,0)),
	ColorSequenceKeypoint.new(0.66, Color3.fromRGB(0,128,255)),
	ColorSequenceKeypoint.new(0.82, Color3.fromRGB(0,0,255)),
	ColorSequenceKeypoint.new(1, Color3.fromRGB(255,0,255)),
})
rainbowGradient.Parent = borderFrame

RunService.Heartbeat:Connect(function(dt)
	rainbowGradient.Rotation = (rainbowGradient.Rotation + dt * 60) % 360
end)

-- Inner frame (gray background)
local innerFrame = Instance.new("Frame")
innerFrame.Size = UDim2.new(1,-6,1,-6)
innerFrame.Position = UDim2.new(0,3,0,3)
innerFrame.BackgroundColor3 = Color3.fromRGB(45,45,50)
innerFrame.Parent = borderFrame
Instance.new("UICorner", innerFrame).CornerRadius = UDim.new(0,10)

--======================== TITLE =========================--

local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1,-PADDING*2,0,TITLE_HEIGHT)
titleLabel.Position = UDim2.new(0,PADDING,0,PADDING)
titleLabel.Text = "Cloud Hub | Flash TP"
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = 16
titleLabel.TextColor3 = Color3.fromRGB(255,255,255)
titleLabel.BackgroundColor3 = Color3.fromRGB(55,55,65)
titleLabel.TextScaled = false
titleLabel.Parent = innerFrame
Instance.new("UICorner", titleLabel).CornerRadius = UDim.new(0,8)

-- Drag functionality (mobile + PC)
do
	local dragging, dragStart, startPos

	local function beginDrag(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1
		or input.UserInputType == Enum.UserInputType.Touch then
			dragging = true
			dragStart = input.Position
			startPos = mainGuiFrame.Position
		end
	end

	local function endDrag(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1
		or input.UserInputType == Enum.UserInputType.Touch then
			dragging = false
		end
	end

	local function dragMoved(input)
		if dragging then
			local delta = input.Position - dragStart
			mainGuiFrame.Position = UDim2.new(
				startPos.X.Scale, startPos.X.Offset + delta.X,
				startPos.Y.Scale, startPos.Y.Offset + delta.Y
			)
		end
	end

	titleLabel.InputBegan:Connect(beginDrag)
	titleLabel.InputEnded:Connect(endDrag)
	UserInputService.InputChanged:Connect(dragMoved)
end

--======================== TP ON STEAL BUTTON =========================--

local yOffset = TITLE_HEIGHT + PADDING*2

local tpBtn = Instance.new("TextButton")
tpBtn.Size = UDim2.new(1,-PADDING*2,0,BUTTON_HEIGHT)
tpBtn.Position = UDim2.new(0,PADDING,0,yOffset)
tpBtn.BackgroundColor3 = Color3.fromRGB(55,55,65)
tpBtn.AutoButtonColor = false
tpBtn.Text = "TP On Steal: OFF"
tpBtn.Font = Enum.Font.GothamBold
tpBtn.TextSize = 15
tpBtn.TextColor3 = Color3.fromRGB(255,255,255)
tpBtn.TextScaled = false
tpBtn.Parent = innerFrame
Instance.new("UICorner", tpBtn).CornerRadius = UDim.new(0,8)

--======================== FOOTER =========================--

yOffset = yOffset + BUTTON_HEIGHT + PADDING

local footer = Instance.new("TextLabel")
footer.Size = UDim2.new(1,-PADDING*2,0,FOOTER_HEIGHT)
footer.Position = UDim2.new(0, PADDING, 0, yOffset)
footer.BackgroundTransparency = 1
footer.Text = "dcd.gg/cloudhub-"
footer.TextColor3 = Color3.fromRGB(150, 150, 255)
footer.Font = Enum.Font.GothamMedium
footer.TextSize = 12
footer.TextXAlignment = Enum.TextXAlignment.Center
footer.TextScaled = false
footer.Parent = innerFrame

--======================== BUTTON LOGIC =========================--

tpBtn.MouseButton1Click:Connect(function()
	tpOnStealEnabled = not tpOnStealEnabled
	tpBtn.Text = tpOnStealEnabled and "TP On Steal: ON" or "TP On Steal: OFF"
	
	TweenService:Create(tpBtn, TweenInfo.new(0.2), {
		BackgroundColor3 = tpOnStealEnabled 
			and Color3.fromRGB(0,170,255) 
			or Color3.fromRGB(55,55,65)
	}):Play()
	
	if tpOnStealEnabled then
		sendNotification("✅ Cloud Hub", "Flash TP enabled!", 3)
	else
		sendNotification("⚠️ Cloud Hub", "Flash TP disabled!", 3)
	end
end)

--======================== PROXIMITY PROMPT DETECTION =========================--

-- Track active prompts
local currentPrompt = nil
local promptConnection = nil

ProximityPromptService.PromptShown:Connect(function(prompt)
	currentPrompt = prompt
end)

ProximityPromptService.PromptHidden:Connect(function(prompt)
	if currentPrompt == prompt then
		currentPrompt = nil
	end
end)

-- Detect E key press on proximity prompts
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	
	if input.KeyCode == Enum.KeyCode.E and currentPrompt and tpOnStealEnabled then
		task.spawn(function()
			-- Wait a tiny bit to let the prompt start
			task.wait(0.05)
			equipFlashTeleport()
		end)
	end
end)

-- Also trigger on prompt hold began
ProximityPromptService.PromptButtonHoldBegan:Connect(function(prompt)
	if tpOnStealEnabled then
		task.spawn(function()
			task.wait(0.05)
			equipFlashTeleport()
		end)
	end
end)

--======================== BUTTON HOVER EFFECTS =========================--

tpBtn.MouseEnter:Connect(function()
	if not tpOnStealEnabled then
		TweenService:Create(tpBtn, TweenInfo.new(0.2), {
			BackgroundColor3 = Color3.fromRGB(65,65,75)
		}):Play()
	end
end)

tpBtn.MouseLeave:Connect(function()
	if not tpOnStealEnabled then
		TweenService:Create(tpBtn, TweenInfo.new(0.2), {
			BackgroundColor3 = Color3.fromRGB(55,55,65)
		}):Play()
	end
end)

--======================== INITIALIZATION =========================--

print("✅ Cloud Hub | Flash TP chargé avec succès!")
print("⚡ Équipe automatiquement Flash Teleport sur les Proximity Prompts")
