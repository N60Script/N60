--================ Services =================
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ProximityPromptService = game:GetService("ProximityPromptService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

--================ Character =================
local character, humanoid, hrp
local freezeConn
local isFrozen = false
local currentPrompt = nil
local promptWatchConn1, promptWatchConn2
local currentWalkSpeed = 15 -- سرعة افتراضية

local function setupCharacter(char)
    character = char
    humanoid = char:WaitForChild("Humanoid")
    hrp = char:WaitForChild("HumanoidRootPart")

    -- God Mode
    humanoid.MaxHealth = math.huge
    humanoid.Health = math.huge
    humanoid:GetPropertyChangedSignal("Health"):Connect(function()
        humanoid.Health = math.huge
    end)

    -- راقب تغير السرعة لاظهار زر Unspeed
    humanoid:GetPropertyChangedSignal("WalkSpeed"):Connect(function()
        if humanoid.WalkSpeed == 15 then
            UnspeedButton.Visible = true
        else
            UnspeedButton.Visible = false
        end
    end)
end

setupCharacter(player.Character or player.CharacterAdded:Wait())
player.CharacterAdded:Connect(setupCharacter)

--================ Freeze Full Body =================
local function freezeCharacter(prompt)
    if isFrozen or not hrp or not humanoid then return end
    isFrozen = true
    currentPrompt = prompt

    humanoid.AutoRotate = false
    humanoid.WalkSpeed = 0
    humanoid.JumpPower = 0
    local cf = hrp.CFrame

    freezeConn = RunService.RenderStepped:Connect(function()
        if hrp then
            hrp.CFrame = cf
        end
    end)

    -- مراقبة اختفاء الـ ProximityPrompt
    promptWatchConn1 = prompt.AncestryChanged:Connect(function(_, parent)
        if not parent then
            unfreezeCharacter()
        end
    end)

    promptWatchConn2 = prompt:GetPropertyChangedSignal("Enabled"):Connect(function()
        if not prompt.Enabled then
            unfreezeCharacter()
        end
    end)
end

function unfreezeCharacter()
    if not isFrozen then return end
    isFrozen = false

    if freezeConn then freezeConn:Disconnect() end
    if promptWatchConn1 then promptWatchConn1:Disconnect() end
    if promptWatchConn2 then promptWatchConn2:Disconnect() end

    humanoid.AutoRotate = true
    currentPrompt = nil
end

--================ Steal Detection =================
local function isStealPrompt(prompt)
    local text = ((prompt.ActionText or "") .. (prompt.ObjectText or "")):lower()
    return text:find("steal") ~= nil
end

--================ Speed + VFly =================
local function runMain()
    local walkSpeed = 15
    local vflySpeed = 15
    local vflyActive = true
    local vflyConn

    local function startVFly()
        if vflyConn then vflyConn:Disconnect() end

        vflyConn = RunService.RenderStepped:Connect(function()
            if not vflyActive then return end
            if not character or not humanoid or humanoid.Health <= 0 then return end
            if not hrp then return end

            local moveDir = humanoid.MoveDirection
            if moveDir.Magnitude > 0 then
                hrp.Velocity = Vector3.new(
                    moveDir.X * vflySpeed,
                    hrp.Velocity.Y,
                    moveDir.Z * vflySpeed
                )
            else
                hrp.Velocity = Vector3.new(0, hrp.Velocity.Y, 0)
            end
        end)
    end

    humanoid.WalkSpeed = walkSpeed
    currentWalkSpeed = walkSpeed
    startVFly()
end

--================ Unspeed Button GUI =================
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SpeedControlGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = playerGui

local UnspeedButton = Instance.new("TextButton")
UnspeedButton.Size = UDim2.new(0,50,0,50)
UnspeedButton.Position = UDim2.new(0.9,0,0.5,-25)
UnspeedButton.BackgroundColor3 = Color3.fromRGB(255,0,0)
UnspeedButton.Text = "Unspeed"
UnspeedButton.Visible = false
UnspeedButton.Parent = ScreenGui

UnspeedButton.MouseButton1Click:Connect(function()
    if humanoid then
        humanoid.WalkSpeed = 15 -- سرعة طبيعية
        currentWalkSpeed = 15
        UnspeedButton.Visible = false
    end
end)

--================ Proximity Events =================
ProximityPromptService.PromptButtonHoldBegan:Connect(function(prompt, plr)
    if plr ~= player then return end
    if not isStealPrompt(prompt) then return end
    freezeCharacter(prompt)
end)

ProximityPromptService.PromptTriggered:Connect(function(prompt, plr)
    if plr ~= player then return end
    if not isStealPrompt(prompt) then return end

    unfreezeCharacter()
    runMain()
end)

ProximityPromptService.PromptButtonHoldEnded:Connect(function(prompt, plr)
    if plr ~= player then return end
    if not isStealPrompt(prompt) then return end
    unfreezeCharacter()
end)
